<ng-template [ngTemplateOutlet]="isEditing ? editDefect : viewDefect" [ngTemplateOutletContext]="{ data: form }"></ng-template>

<ng-template #viewDefect let-data="data">
  <h1 class="govuk-heading-l">Defect details</h1>
  <div class="govuk-grid-row govuk-!-margin-bottom-5">
    <div class="govuk-grid-column-two-thirds">
      <span class="govuk-caption-m">{{ defect.imDescription }}</span>
      <h2 class="govuk-heading-s">{{ defect.deficiencyRef }} - {{ defect.itemDescription }} {{ defect.deficiencyText }}</h2>
      <span class="govuk-tag govuk-tag--orange">{{ defect.deficiencyCategory }}</span>
      <span *ngIf="defect.prs" id="prs-display" class="govuk-tag hidden">PRS</span>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h2 class="govuk-heading-m">Defect Details</h2>
      <dl class="govuk-summary-list">
        <ng-template
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Category', data: combined(defect.imNumber, defect.imDescription) }"
        ></ng-template>
      </dl>
    </div>
  </div>
  <ng-template
    [ngTemplateOutlet]="viewDefectRow"
    [ngTemplateOutletContext]="{ label: 'Item', data: combined(defect.itemNumber, defect.itemDescription) }"
  ></ng-template>
  <ng-template
    [ngTemplateOutlet]="viewDefectRow"
    [ngTemplateOutletContext]="{
      label: 'Description',
      data: combined(defect.deficiencyId, defect.deficiencySubId, defect.deficiencyText)
    }"
  ></ng-template>
  <ng-template
    [ngTemplateOutlet]="viewDefectRow"
    [ngTemplateOutletContext]="{ label: 'Location', data: combined(mapLocationText(defect.additionalInformation?.location)) }"
  ></ng-template>
  <ng-template
    [ngTemplateOutlet]="viewDefectRow"
    [ngTemplateOutletContext]="{ label: 'Prohibition issued', data: combined(defect.prohibitionIssued) }"
  ></ng-template>
  <ng-template
    [ngTemplateOutlet]="viewDefectRow"
    [ngTemplateOutletContext]="{ label: 'Additional defect details', data: combined(defect.additionalInformation?.notes) }"
  ></ng-template>
</ng-template>

<ng-template #viewDefectRow let-label="label" let-data="data">
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">{{ label }}</dt>
    <dd class="govuk-summary-list__value">{{ data }}</dd>
  </div>
</ng-template>

<ng-template #editDefect>
  <h1 class="govuk-heading-l">Defect details</h1>
  <div class="govuk-grid-row govuk-!-margin-bottom-5">
    <div class="govuk-grid-column-two-thirds">
      <span class="govuk-caption-m">{{ defect.imDescription }}</span>
      <h2 class="govuk-heading-s">{{ defect.deficiencyRef }} - {{ defect.itemDescription }} {{ defect.deficiencyText }}</h2>
      <span class="govuk-tag govuk-tag--orange">{{ defect.deficiencyCategory }}</span>
      <span *ngIf="defect.prs" id="prs-display" class="govuk-tag hidden">PRS</span>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h3 class="govuk-heading-m">Defect details</h3>
      <p class="govuk-hint">Fill any defect details that apply</p>
    </div>
  </div>
  <ng-container [formGroup]="form">
    <ng-container formGroupName="additionalInformation">
      <ng-container formGroupName="location">
        <app-radio-group
          *ngFor="let item of infoDictionary | keyvalue; trackBy: trackByFn"
          [name]="item.key + index"
          [label]="pascalCase(item.key)"
          [formControlName]="item.key"
          [options]="item.value"
        ></app-radio-group>
      </ng-container>
      <app-text-input *ngIf="includeNotes" [name]="'notes-' + index" label="Notes" formControlName="notes"></app-text-input>
    </ng-container>

    <app-radio-group *ngIf="!isAdvisory" [name]="'prs-' + index" label="PRS" formControlName="prs" [options]="booleanOptions"></app-radio-group>
    <app-radio-group
      *ngIf="isDangerous"
      [name]="'prohibitionIssued-' + index"
      label="Prohibition issued"
      formControlName="prohibitionIssued"
      [options]="booleanOptions"
    ></app-radio-group>
  </ng-container>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <div class="govuk-button-group">
        <button class="govuk-button" (click)="handleSubmit()">Confirm</button>
        <a class="govuk-button govuk-button--warning" role="button" (click)="handleRemove()">Remove defect</a>
        <a class="govuk-link govuk-link--no-visited-state" (click)="navigateBack()">Cancel changes</a>
      </div>
    </div>
  </div>
</ng-template>
