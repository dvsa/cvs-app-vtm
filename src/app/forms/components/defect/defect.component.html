<ng-template [ngTemplateOutlet]="isEditing ? editDefect : viewDefect" [ngTemplateOutletContext]="{ data: form }"></ng-template>

<ng-template #viewDefect let-data="data">
  <h1 class="govuk-heading-l">Defect details</h1>
  <div class="govuk-grid-row govuk-!-margin-bottom-5">
    <div class="govuk-grid-column-two-thirds">
      <span class="govuk-caption-m">{{ defect!.imDescription }}</span>
      <h2 class="govuk-heading-s">{{ defect!.deficiencyRef }} - {{ defect!.itemDescription }} {{ defect!.deficiencyText }}</h2>
      <app-tag [type]="categoryColor(defect!.deficiencyCategory)">{{ defect!.deficiencyCategory }}</app-tag>
      <span *ngIf="defect!.prs" id="prs-display" class="govuk-tag hidden">PRS</span>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h2 class="govuk-heading-m">Defect location</h2>
      <dl class="govuk-summary-list">
        <ng-template
          *ngIf="defect!.additionalInformation?.location?.vertical"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Vertical', data: defect!.additionalInformation?.location?.vertical }"
        ></ng-template>
        <ng-template
          *ngIf="defect!.additionalInformation?.location?.horizontal"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Horizontal', data: defect!.additionalInformation?.location?.horizontal }"
        ></ng-template>
        <ng-template
          *ngIf="defect!.additionalInformation?.location?.lateral"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Lateral', data: defect!.additionalInformation?.location?.lateral }"
        ></ng-template>
        <ng-template
          *ngIf="defect!.additionalInformation?.location?.longitudinal"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Longitudinal', data: defect!.additionalInformation?.location?.longitudinal }"
        ></ng-template>
        <ng-template
          *ngIf="defect!.additionalInformation?.location?.rowNumber"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Row Number', data: defect!.additionalInformation?.location?.rowNumber }"
        ></ng-template>
        <ng-template
          *ngIf="defect!.additionalInformation?.location?.seatNumber"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Seat Number', data: defect!.additionalInformation?.location?.seatNumber }"
        ></ng-template>
        <ng-template
          *ngIf="defect!.additionalInformation?.location?.axleNumber"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Axle Number', data: defect!.additionalInformation?.location?.axleNumber }"
        ></ng-template>
        <ng-template
          *ngIf="defect!.additionalInformation?.notes"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Notes', data: defect!.additionalInformation?.notes }"
        ></ng-template>
        <ng-template
          *ngIf="isDangerous"
          [ngTemplateOutlet]="viewDefectRow"
          [ngTemplateOutletContext]="{ label: 'Prohibition Issued', data: defect!.prohibitionIssued }"
        ></ng-template>
      </dl>
    </div>
  </div>
</ng-template>

<ng-template #viewDefectRow let-label="label" let-data="data">
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">{{ label }}</dt>
    <dd class="govuk-summary-list__value">{{ data }}</dd>
  </div>
</ng-template>

<ng-template #editDefect>
  <h1 class="govuk-heading-l">Defect details</h1>
  <div class="govuk-grid-row govuk-!-margin-bottom-5">
    <div class="govuk-grid-column-two-thirds">
      <span class="govuk-caption-m">{{ defect!.imDescription }}</span>
      <h2 class="govuk-heading-s">{{ defect!.deficiencyRef }} - {{ defect!.itemDescription }} {{ defect!.deficiencyText }}</h2>
      <app-tag [type]="categoryColor(defect!.deficiencyCategory)">{{ defect!.deficiencyCategory }}</app-tag>
      <span *ngIf="defect!.prs" id="prs-display" class="govuk-tag hidden">PRS</span>
    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <h3 class="govuk-heading-m">Defect details</h3>
      <p class="govuk-hint">Fill any defect details that apply</p>
    </div>
  </div>
  <ng-container [formGroup]="form">
    <ng-container formGroupName="additionalInformation">
      <ng-container formGroupName="location">
        <ng-container *ngFor="let item of infoDictionary | keyvalue; trackBy: trackByFn">
          <app-radio-group
            *ngIf="item.value.length <= 4"
            [name]="item.key + index"
            [label]="pascalCase(item.key)"
            [formControlName]="item.key"
            [options]="item.value"
            [inline]="item.value.length <= 2"
          ></app-radio-group>

          <app-select
            *ngIf="item.value.length >= 5"
            [name]="item.key + index"
            [label]="pascalCase(item.key)"
            [formControlName]="item.key"
            [options]="item.value"
          ></app-select>
        </ng-container>
      </ng-container>
      <app-text-area *ngIf="includeNotes || isAdvisory" [name]="'notes-' + index" label="Notes" formControlName="notes"></app-text-area>
    </ng-container>

    <div class="govuk-form-group" *ngIf="isDangerous">
      <div class="govuk-checkboxes" data-module="govuk-checkboxes">
        <div class="govuk-checkboxes__item">
          <input
            class="govuk-checkboxes__input"
            id="prohibition"
            name="prohibition"
            type="checkbox"
            [checked]="defect?.prohibitionIssued"
            (change)="toggleProhibition()"
          />
          <label class="govuk-label govuk-checkboxes__label" for="prohibition"> Prohibition issued in mobile compliance </label>
        </div>
      </div>
    </div>

    <div class="govuk-form-group" *ngIf="!isAdvisory">
      <div class="govuk-checkboxes" data-module="govuk-checkboxes">
        <div class="govuk-checkboxes__item">
          <input class="govuk-checkboxes__input" id="prs" [name]="'prs-' + index" type="checkbox" [checked]="defect?.prs" (change)="togglePRS()" />
          <label class="govuk-label govuk-checkboxes__label" for="prs"> Defect repaired during test </label>
        </div>
      </div>
    </div>

    <!-- <app-radio-group
      *ngIf="isDangerous"
      [name]="'prohibitionIssued-' + index"
      label="Prohibition issued"
      formControlName="prohibitionIssued"
      [options]="booleanOptions"
      [inline]="true"
    ></app-radio-group> -->
  </ng-container>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
      <div class="govuk-button-group">
        <button class="govuk-button" (click)="handleSubmit()">Confirm</button>
        <a *ngIf="index || index === 0" class="govuk-button govuk-button--warning" role="button" (click)="handleRemove()">Remove defect</a>
        <a class="govuk-link govuk-link--no-visited-state" (click)="navigateBack()">{{ index || index === 0 ? 'Cancel changes' : 'Cancel' }}</a>
      </div>
    </div>
  </div>
</ng-template>
